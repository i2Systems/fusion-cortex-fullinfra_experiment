generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BACnetMapping {
  id             String       @id
  zoneId         String       @unique
  bacnetObjectId String?
  status         BACnetStatus @default(NOT_ASSIGNED)
  lastConnected  DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Zone           Zone         @relation(fields: [zoneId], references: [id], onDelete: Cascade)
}

model Device {
  id                    String                 @id
  serialNumber          String                 @unique
  deviceId              String
  type                  DeviceType
  status                DeviceStatus           @default(OFFLINE)
  x                     Float?
  y                     Float?
  orientation           Float?
  signal                Int?
  battery               Int?
  buildDate             DateTime?
  cct                   Int?
  warrantyStatus        String?
  warrantyExpiry        DateTime?
  partsList             Json?
  parentId              String?
  componentType         String?
  componentSerialNumber String?
  firmwareVersion       String?
  firmwareTarget        String?
  firmwareStatus        FirmwareStatus         @default(UP_TO_DATE)
  lastFirmwareUpdate    DateTime?
  siteId                String
  assignedToPersonId    String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime
  Device                Device?                @relation("DeviceToDevice", fields: [parentId], references: [id], onDelete: Cascade)
  other_Device          Device[]               @relation("DeviceToDevice")
  Site                  Site                   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  AssignedToPerson      Person?                @relation("DeviceAssignment", fields: [assignedToPersonId], references: [id], onDelete: SetNull)
  Fault                 Fault[]
  FirmwareDeviceUpdate  FirmwareDeviceUpdate[]
  GroupDevice           GroupDevice[]
  Rule                  Rule[]
  ZoneDevice            ZoneDevice[]

  @@index([deviceId])
  @@index([assignedToPersonId])
  @@index([firmwareStatus])
  @@index([firmwareVersion])
  @@index([parentId])
  @@index([serialNumber])
  @@index([siteId])
  
  // Composite indexes for performance
  @@index([siteId, status])
  @@index([siteId, type])
  @@index([siteId, warrantyExpiry])
  @@index([siteId, signal])
  @@index([siteId, parentId])
}

model Fault {
  id          String    @id
  deviceId    String
  faultType   String
  description String
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  detectedAt  DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Device      Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([detectedAt])
  @@index([deviceId])
  @@index([resolved])
  @@index([deviceId, resolved])
}

model FirmwareDeviceUpdate {
  id               String               @id
  firmwareUpdateId String
  deviceId         String
  status           FirmwareDeviceStatus @default(PENDING)
  errorMessage     String?
  startedAt        DateTime?
  completedAt      DateTime?
  retryCount       Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime
  Device           Device               @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  FirmwareUpdate   FirmwareUpdate       @relation(fields: [firmwareUpdateId], references: [id], onDelete: Cascade)

  @@unique([firmwareUpdateId, deviceId])
  @@index([deviceId])
  @@index([status])
}

model FirmwareUpdate {
  id                   String                 @id
  name                 String
  description          String?
  version              String
  fileUrl              String?
  siteId               String?
  deviceTypes          DeviceType[]
  status               FirmwareUpdateStatus   @default(PENDING)
  totalDevices         Int                    @default(0)
  completed            Int                    @default(0)
  failed               Int                    @default(0)
  inProgress           Int                    @default(0)
  scheduledAt          DateTime?
  startedAt            DateTime?
  completedAt          DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  FirmwareDeviceUpdate FirmwareDeviceUpdate[]
  Site                 Site?                  @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([status])
  @@index([siteId, status])
}

model LibraryImage {
  id        String   @id
  libraryId String   @unique
  imageUrl  String?
  mimeType  String   @default("image/jpeg")
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([libraryId])
}

model Location {
  id             String     @id
  name           String
  type           String
  imageUrl       String?
  vectorDataUrl  String?
  zoomBounds     Json?
  parentId       String?
  siteId         String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  Location       Location?  @relation("LocationToLocation", fields: [parentId], references: [id], onDelete: Cascade)
  other_Location Location[] @relation("LocationToLocation")
  Site           Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([parentId])
  @@index([siteId])
}

model Rule {
  id            String    @id
  name          String
  description   String?
  ruleType      String    @default("rule")
  targetType    String    @default("zone")
  targetId      String?
  targetName    String?
  trigger       String
  condition     Json
  action        Json
  overrideBMS   Boolean   @default(false)
  duration      Int?
  siteId        String
  zoneId        String?
  deviceId      String?
  targetZones   String[]
  enabled       Boolean   @default(true)
  lastTriggered DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  Site          Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  Zone          Zone?     @relation(fields: [zoneId], references: [id])
  Device        Device?   @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([zoneId])
  @@index([deviceId])
  @@index([siteId, enabled])
}

model Site {
  id             String           @id
  name           String
  storeNumber    String?
  address        String?
  city           String?
  state          String?
  zipCode        String?
  phone          String?
  manager        String?
  squareFootage  Int?
  openedDate     DateTime?
  imageUrl       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Device         Device[]
  FirmwareUpdate FirmwareUpdate[]
  Group          Group[]
  Location       Location[]
  Person         Person[]
  Rule           Rule[]
  Zone           Zone[]
}

model Zone {
  id              String         @id
  name            String
  color           String         @default("#4c7dff")
  description     String?
  polygon         Json?
  daylightEnabled Boolean        @default(false)
  minDaylight     Int?
  siteId          String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  BACnetMapping   BACnetMapping?
  Rule            Rule[]
  Site            Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  ZoneDevice      ZoneDevice[]

  @@index([siteId])
  @@index([siteId, daylightEnabled])
}

model ZoneDevice {
  id       String @id
  zoneId   String
  deviceId String
  Device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  Zone     Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([zoneId, deviceId])
  @@index([deviceId])
  @@index([zoneId])
}


model Group {
  id          String        @id
  name        String
  description String?
  color       String        @default("#4c7dff")
  siteId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  Site        Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  GroupDevice GroupDevice[]
  GroupPerson GroupPerson[]

  @@index([siteId])
}

model GroupDevice {
  id       String @id
  groupId  String
  deviceId String
  Device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  Group    Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, deviceId])
  @@index([deviceId])
  @@index([groupId])
}

model GroupPerson {
  id       String @id
  groupId  String
  personId String
  Person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  Group    Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, personId])
  @@index([personId])
  @@index([groupId])
}

model Person {
  id          String       @id
  firstName   String
  lastName    String
  email       String?
  role        String?
  imageUrl    String?
  x           Float?
  y           Float?
  siteId      String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Site        Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  GroupPerson GroupPerson[]
  AssignedDevices Device[] @relation("DeviceAssignment")

  @@index([siteId])
}

enum BACnetStatus {
  CONNECTED
  ERROR
  NOT_ASSIGNED
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  MISSING
  DUPLICATE
}

enum DeviceType {
  FIXTURE_16FT_POWER_ENTRY
  FIXTURE_12FT_POWER_ENTRY
  FIXTURE_8FT_POWER_ENTRY
  FIXTURE_16FT_FOLLOWER
  FIXTURE_12FT_FOLLOWER
  FIXTURE_8FT_FOLLOWER
  MOTION_SENSOR
  LIGHT_SENSOR
}

enum FirmwareDeviceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

enum FirmwareStatus {
  UP_TO_DATE
  UPDATE_AVAILABLE
  UPDATE_IN_PROGRESS
  UPDATE_FAILED
  UPDATE_REQUIRED
}

enum FirmwareUpdateStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}
